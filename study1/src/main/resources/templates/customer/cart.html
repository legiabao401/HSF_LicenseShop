<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Giỏ hàng - License Shop</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <link rel="stylesheet" href="/css/product-styles.css"/>
    <style>
        .navbar-brand span { color: #0d6efd; font-weight: 700; }
        :root { --brand: #0d6efd; --shopee-orange: #ee4d2d; }
        .btn-primary { background-color: var(--brand); border-color: var(--brand); }
        .btn-primary:hover { filter: brightness(0.95); }
        .page-title { font-weight: 700; }
        .card-shadow { box-shadow: 0 6px 20px rgba(0,0,0,.06); }
        .table > :not(caption) > * > * { vertical-align: middle; }
        .empty-state { padding: 2rem 1rem; text-align: center; color: #6c757d; }
        
        /* Shopee-style cart */
        .cart-item { border: 1px solid #e9ecef; border-radius: 8px; margin-bottom: 10px; }
        .cart-item-header { background: #f8f9fa; padding: 10px 15px; border-bottom: 1px solid #e9ecef; }
        .cart-item-body { padding: 15px; }
        .product-checkbox { transform: scale(1.2); }
        .product-image { width: 80px; height: 80px; object-fit: cover; border-radius: 4px; }
        .quantity-controls { display: flex; align-items: center; border: 1px solid #ced4da; border-radius: 4px; overflow: hidden; }
        .quantity-controls .btn { flex-shrink: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border: none; border-radius: 0; }
        .quantity-controls input { flex-grow: 1; border: none; text-align: center; -moz-appearance: textfield; }
        .quantity-controls input::-webkit-outer-spin-button,
        .quantity-controls input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .checkout-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #e9ecef; padding: 15px; z-index: 1000; }
        .checkout-bar .container { display: flex; align-items: center; justify-content: space-between; }
        .selected-count { color: #6c757d; font-size: 14px; }
        .checkout-btn { background: var(--shopee-orange); border: none; color: white; padding: 12px 30px; border-radius: 4px; font-weight: 600; }
        .checkout-btn:hover { background: #d73502; color: white; }
        .checkout-btn:disabled { background: #ccc; cursor: not-allowed; }
        .total-price { font-size: 18px; font-weight: 700; color: var(--shopee-orange); }
        .shop-name { color: #6c757d; font-size: 12px; }
        .product-name { font-weight: 600; margin-bottom: 5px; }
        .product-price { color: var(--shopee-orange); font-weight: 700; }
        .remove-btn { color: #6c757d; background: none; border: none; padding: 5px; }
        .remove-btn:hover { color: #dc3545; }
        body { padding-bottom: 80px; }
    </style>
    <script src="/js/auth.js"></script>
    <script>
        function formatMoney(n){
            const num = Number(n || 0);
            return num.toLocaleString('vi-VN', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        }

        // Global variables for cart management
        let cartItems = [];
        let selectedItems = new Set();

        async function loadCart() {
            try {
                console.log('Đang tải giỏ hàng...');
                
                const res = await fetch('/api/cart', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin'
                });
                
                if (res.status === 401) { 
                    window.location.href = '/login'; 
                    return; 
                }
                
                if (!res.ok) {
                    const errorText = await res.text();
                    throw new Error(`API Error: ${res.status} - ${errorText}`);
                }
                
                const response = await res.json();
                if (typeof response === 'string') {
                    throw new Error(`Server Error: ${response}`);
                }
                
                const cart = response;
                cartItems = cart.items || [];
                
                renderCartItems();
                updateCheckoutBar();
                
            } catch(e) {
                console.error('Lỗi tải giỏ hàng:', e);
                showErrorState(e.message);
            }
        }

        function renderCartItems() {
            const cartContainer = document.getElementById('cart-container');
                const emptyEl = document.getElementById('empty');
            
            if (!cartItems.length) {
                cartContainer.innerHTML = '';
                    emptyEl.classList.remove('d-none');
                emptyEl.innerHTML = `
                    <div class="mb-2"><i class="fa-regular fa-face-frown fa-2x"></i></div>
                    <div class="mb-3">Giỏ hàng của bạn đang trống</div>
                    <a href="/products" class="btn btn-primary btn-sm">Xem sản phẩm</a>
                `;
                return;
            }
            
                    emptyEl.classList.add('d-none');
            
            // Group items by shop
            const shopGroups = {};
            cartItems.forEach(item => {
                const shopId = item.product?.shopId || 'unknown';
                if (!shopGroups[shopId]) {
                    shopGroups[shopId] = [];
                }
                shopGroups[shopId].push(item);
            });
            
            let html = '';
            Object.keys(shopGroups).forEach(shopId => {
                const items = shopGroups[shopId];
                const shopName = items[0]?.product?.shopName || 'Cửa hàng';
                
                html += `
                    <div class="cart-item">
                        <div class="cart-item-header">
                            <div class="form-check">
                                <input class="form-check-input shop-checkbox" type="checkbox" 
                                       data-shop-id="${shopId}" 
                                       onchange="toggleShopItems('${shopId}', this.checked)">
                                <label class="form-check-label fw-semibold">
                                    ${shopName}
                                </label>
                            </div>
                        </div>
                        <div class="cart-item-body">
                `;
                
                items.forEach(item => {
                    const price = Number(item.product?.price || 0);
                    const qty = Number(item.quantity || 1);
                    const subtotal = price * qty;
                    const isSelected = selectedItems.has(item.product?.id);
                    
                    html += `
                        <div class="row align-items-center mb-3">
                            <div class="col-1">
                                <div class="form-check">
                                    <input class="form-check-input product-checkbox" type="checkbox" 
                                           data-product-id="${item.product?.id}" 
                                           ${isSelected ? 'checked' : ''}
                                           onchange="toggleItem(${item.product?.id}, this.checked)">
                                </div>
                            </div>
                            <div class="col-2">
                                <img src="/images/products/default.jpg" alt="${item.product?.name}" 
                                     class="product-image" onerror="this.src='/images/placeholder.svg'">
                            </div>
                            <div class="col-4">
                                <div class="product-name">${item.product?.name || 'Sản phẩm không xác định'}</div>
                                <div class="shop-name">${shopName}</div>
                            </div>
                            <div class="col-2">
                                <div class="product-price">${formatMoney(price)} ₫</div>
                            </div>
                            <div class="col-2">
                                <div class="quantity-controls">
                                    <button class="btn btn-outline-secondary" type="button" 
                                            onclick="updateQty(${item.product?.id}, Math.max(1, ${qty}-1))">
                                        <i class="fa-solid fa-minus"></i>
                                    </button>
                                    <input class="form-control text-center" type="number" min="1" 
                                           value="${qty}" onchange="updateQty(${item.product?.id}, this.value)">
                                    <button class="btn btn-outline-secondary" type="button" 
                                            onclick="updateQty(${item.product?.id}, ${qty}+1)">
                                        <i class="fa-solid fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-1 text-end">
                                <div class="product-price">${formatMoney(subtotal)} ₫</div>
                                <button class="remove-btn" onclick="removeItem(${item.product?.id})" title="Xóa">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            cartContainer.innerHTML = html;
        }

        function toggleItem(productId, checked) {
            if (checked) {
                selectedItems.add(productId);
            } else {
                selectedItems.delete(productId);
            }
            updateCheckoutBar();
            updateShopCheckboxes();
        }

        function toggleShopItems(shopId, checked) {
            const shopItems = cartItems.filter(item => item.product?.shopId == shopId);
            shopItems.forEach(item => {
                if (checked) {
                    selectedItems.add(item.product?.id);
                } else {
                    selectedItems.delete(item.product?.id);
                }
            });
            renderCartItems();
            updateCheckoutBar();
        }

        function updateShopCheckboxes() {
            const shopGroups = {};
            cartItems.forEach(item => {
                const shopId = item.product?.shopId || 'unknown';
                if (!shopGroups[shopId]) {
                    shopGroups[shopId] = [];
                }
                shopGroups[shopId].push(item);
            });
            
            Object.keys(shopGroups).forEach(shopId => {
                const items = shopGroups[shopId];
                const allSelected = items.every(item => selectedItems.has(item.product?.id));
                const someSelected = items.some(item => selectedItems.has(item.product?.id));
                
                const checkbox = document.querySelector(`input[data-shop-id="${shopId}"]`);
                if (checkbox) {
                    checkbox.checked = allSelected;
                    checkbox.indeterminate = someSelected && !allSelected;
                }
            });
        }

        function updateCheckoutBar() {
            const selectedCount = selectedItems.size;
            const totalPrice = cartItems
                .filter(item => selectedItems.has(item.product?.id))
                .reduce((sum, item) => {
                    const price = Number(item.product?.price || 0);
                    const qty = Number(item.quantity || 1);
                    return sum + (price * qty);
                }, 0);
            
            document.getElementById('selected-count').textContent = `Đã chọn ${selectedCount} sản phẩm`;
            document.getElementById('total-price').textContent = `${formatMoney(totalPrice)} ₫`;
            
            const checkoutBtn = document.getElementById('checkout-btn');
            checkoutBtn.disabled = selectedCount === 0;
        }

        function showErrorState(message) {
            const emptyEl = document.getElementById('empty');
            const cartContainer = document.getElementById('cart-container');
            cartContainer.innerHTML = '';
            emptyEl.classList.remove('d-none');
            emptyEl.innerHTML = `
                <div class="mb-2"><i class="fa-solid fa-exclamation-triangle fa-2x text-warning"></i></div>
                <div class="mb-3">Lỗi tải giỏ hàng: ${message}</div>
                <button class="btn btn-primary btn-sm" onclick="loadCart()">Thử lại</button>
            `;
        }

        async function addItem(productId, quantity = 1) {
            try {
                const res = await fetch(`/api/cart/add/${productId}?quantity=${quantity}`, { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin'
                });
                
                if (res.status === 401) { 
                    window.location.href = '/login'; 
                    return; 
                }
                
                if (!res.ok) {
                    const errorText = await res.text();
                    throw new Error(`API Error: ${res.status} - ${errorText}`);
                }
                
                const response = await res.json();
                if (typeof response === 'string') {
                    throw new Error(`Server Error: ${response}`);
                }
                
                await loadCart();
            } catch (e) {
                console.error('Error adding item:', e);
                showNotification('Lỗi thêm sản phẩm: ' + e.message, 'error');
            }
        }

        async function updateQty(productId, quantity) {
            try {
                const q = Math.max(1, parseInt(quantity || '1', 10));
                const res = await fetch(`/api/cart/update/${productId}?quantity=${q}`, { 
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin'
                });
                
                if (res.status === 401) { 
                    window.location.href = '/login'; 
                    return; 
                }
                
                if (!res.ok) {
                    const errorText = await res.text();
                    throw new Error(`API Error: ${res.status} - ${errorText}`);
                }
                
                const response = await res.json();
                if (typeof response === 'string') {
                    throw new Error(`Server Error: ${response}`);
                }
                
                await loadCart();
            } catch (e) {
                console.error('Error updating quantity:', e);
                showNotification('Lỗi cập nhật số lượng: ' + e.message, 'error');
            }
        }

        async function removeItem(productId) {
            try {
                const res = await fetch(`/api/cart/remove/${productId}`, { 
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin'
                });
                
                if (res.status === 401) { 
                    window.location.href = '/login'; 
                    return; 
                }
                
                if (!res.ok) {
                    const errorText = await res.text();
                    throw new Error(`API Error: ${res.status} - ${errorText}`);
                }
                
                const response = await res.json();
                if (typeof response === 'string') {
                    throw new Error(`Server Error: ${response}`);
                }
                
                await loadCart();
            } catch (e) {
                console.error('Error removing item:', e);
                showNotification('Lỗi xóa sản phẩm: ' + e.message, 'error');
            }
        }

        async function clearCart() {
            try {
                const res = await fetch(`/api/cart/clear`, { 
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin'
                });
                
                if (res.status === 401) { 
                    window.location.href = '/login'; 
                    return; 
                }
                
                if (!res.ok) {
                    const errorText = await res.text();
                    throw new Error(`API Error: ${res.status} - ${errorText}`);
                }
                
                const response = await res.json();
                if (typeof response === 'string') {
                    throw new Error(`Server Error: ${response}`);
                }
                
            await loadCart();
            } catch (e) {
                console.error('Error clearing cart:', e);
                showNotification('Lỗi xóa giỏ hàng: ' + e.message, 'error');
            }
        }

        function showNotification(message, type) {
            // Tạo thông báo toast
            const toast = document.createElement('div');
            toast.className = `alert alert-${type === 'success' ? 'success' : 'danger'} position-fixed`;
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            toast.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fa-solid fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
                    <span>${message}</span>
                    <button type="button" class="btn-close ms-auto" onclick="this.parentElement.parentElement.remove()"></button>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Tự động xóa sau 3 giây
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 3000);
        }

        function toggleAllItems(checked) {
            if (checked) {
                cartItems.forEach(item => {
                    selectedItems.add(item.product?.id);
                });
            } else {
                selectedItems.clear();
            }
            renderCartItems();
            updateCheckoutBar();
        }

        async function checkout() {
            if (selectedItems.size === 0) {
                showNotification('Vui lòng chọn ít nhất một sản phẩm để thanh toán', 'error');
                return;
            }
            
            try {
                // Disable checkout button to prevent double-click
                const checkoutBtn = document.getElementById('checkout-btn');
                checkoutBtn.disabled = true;
                checkoutBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-2"></i>Đang xử lý...';
                
                // Prepare cart data for improved payment system
                console.log('All cart items:', cartItems.map(item => ({ id: item.product?.id, name: item.product?.name })));
                console.log('Selected items Set:', Array.from(selectedItems));
                const selectedCartItems = cartItems.filter(item => selectedItems.has(item.product?.id));
                console.log('Selected cart items:', selectedCartItems.map(item => ({ id: item.product?.id, name: item.product?.name })));
                console.log('Total cart items:', cartItems.length);
                
                const cartData = selectedCartItems.map(item => ({
                    productId: item.product?.id,
                    quantity: item.quantity,
                    price: item.product?.price,
                    name: item.product?.name,
                    warehouseId: item.product?.id, // Sử dụng productId làm warehouseId tạm thời
                    stallId: item.product?.stallId,
                    shopId: item.product?.shopId,
                    sellerId: item.product?.shop?.userId || item.product?.shopId
                }));
                
                const totalAmount = selectedCartItems.reduce((sum, item) => {
                    const price = Number(item.product?.price || 0);
                    const qty = Number(item.quantity || 1);
                    return sum + (price * qty);
                }, 0);
                
                console.log('Cart data to send:', cartData);
                console.log('Total amount:', totalAmount);
                
                // Call improved payment API
                const response = await fetch('/api/improved-payment/process-cart', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        cartItems: cartData,
                        totalAmount: totalAmount,
                        paymentMethod: 'WALLET',
                        notes: 'Thanh toán từ giỏ hàng'
                    })
                });
                
                if (response.status === 401) {
                    window.location.href = '/login';
                    return;
                }
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API Error: ${response.status} - ${errorText}`);
                }
                
                const result = await response.json();

                if (result.success) {
                    showNotification('Đơn hàng đã được gửi vào hàng đợi xử lý! Tiền sẽ được giữ trong 1 phút.', 'success');
                    
                    // Clear selected items from cart
                    selectedItems.clear();
                    await loadCart();
                    
                    // Show payment status modal with payment ID
                    if (result.paymentId) {
                        showPaymentStatusModal(result.paymentId);
                    } else {
                        showPaymentStatusModal(null);
                    }
                } else {
                    // Hiển thị thông báo cụ thể khi không đủ số dư ví
                    if (result.message && result.message.includes('Số dư ví không đủ')) {
                        showNotification('Số dư ví không đủ để thanh toán. Vui lòng nạp tiền trước khi tiếp tục.', 'error');
                        return;
                    }
                    // Hiển thị thông báo cụ thể khi hết hàng
                    if (result.message && result.message.includes('Sản phẩm hết hàng')) {
                        showNotification(result.message, 'error');
                        return;
                    }
                    // Hiển thị thông báo khi có người khác mua trước (race condition)
                    if (result.message && (result.message.includes('có thể đã có người khác mua trước') || 
                                          result.message.includes('không thể khóa đủ số lượng'))) {
                        showNotification('Xin lỗi! Có người khác đã mua sản phẩm này trước bạn. Vui lòng kiểm tra lại giỏ hàng.', 'error');
                        await loadCart(); // Reload cart để cập nhật trạng thái
                        return;
                    }
                    throw new Error(result.message || 'Lỗi xử lý thanh toán');
                }
                
            } catch (error) {
                console.error('Checkout error:', error);
                showNotification('Lỗi thanh toán: ' + error.message, 'error');
            } finally {
                // Re-enable checkout button
                const checkoutBtn = document.getElementById('checkout-btn');
                checkoutBtn.disabled = selectedItems.size === 0;
                checkoutBtn.innerHTML = 'Mua hàng';
            }
        }
        
        // Global variables for payment status tracking
        let currentPaymentId = null;
        let paymentStatusInterval = null;

        function showPaymentStatusModal(paymentId) {
            currentPaymentId = paymentId;
            
            // Create modal for payment status
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.id = 'paymentStatusModal';
            modal.setAttribute('data-bs-backdrop', 'static');
            modal.setAttribute('data-bs-keyboard', 'false');
            modal.innerHTML = `
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fa-solid fa-clock me-2 text-warning"></i>
                                Đang xử lý thanh toán
                            </h5>
                        </div>
                        <div class="modal-body text-center">
                            <div class="alert alert-info">
                                <i class="fa-solid fa-info-circle me-2"></i>
                                <strong>Đơn hàng của bạn đang được xử lý, vui lòng đợi trong chốc lát...</strong>
                            </div>
                            <div class="d-flex align-items-center justify-content-center mb-3">
                                <div class="spinner-border spinner-border-sm me-2 text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <span>Đang kiểm tra kho hàng và khóa sản phẩm...</span>
                            </div>
                            <div class="progress mb-3" style="height: 6px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 0%" id="paymentProgress"></div>
                            </div>
                            <small class="text-muted">Quá trình này thường mất 10-30 giây</small>
                        </div>
                        <div class="modal-footer justify-content-center">
                            <button type="button" class="btn btn-outline-secondary" onclick="closePaymentModal()">
                                <i class="fa-solid fa-times me-2"></i>Đóng
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            // Start polling for payment status
            startPaymentStatusPolling();
            
            // Update progress bar
            updateProgressBar();
        }

        function startPaymentStatusPolling() {
            if (paymentStatusInterval) {
                clearInterval(paymentStatusInterval);
            }
            
            let progress = 0;
            paymentStatusInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/improved-payment/status/${currentPaymentId}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        credentials: 'same-origin'
                    });
                    
                    if (response.ok) {
                        const statusData = await response.json();
                        
                        if (statusData.success) {
                            const status = statusData.status;
                            
                            if (status === 'COMPLETED') {
                                // Payment successful
                                clearInterval(paymentStatusInterval);
                                showPaymentSuccessModal();
                                return;
                            } else if (status === 'FAILED') {
                                // Payment failed
                                clearInterval(paymentStatusInterval);
                                showPaymentFailedModal(statusData.errorMessage || 'Không xác định được nguyên nhân');
                                return;
                            }
                        }
                    }
                    
                    // Update progress
                    progress += 5;
                    if (progress > 90) progress = 90;
                    updateProgressBar(progress);
                    
                } catch (error) {
                    console.error('Error checking payment status:', error);
                }
            }, 2000); // Check every 2 seconds
            
            // Timeout after 60 seconds
            setTimeout(() => {
                if (paymentStatusInterval) {
                    clearInterval(paymentStatusInterval);
                    showPaymentTimeoutModal();
                }
            }, 60000);
        }

        function updateProgressBar(progress = 0) {
            const progressBar = document.getElementById('paymentProgress');
            if (progressBar) {
                progressBar.style.width = progress + '%';
            }
        }

        function showPaymentSuccessModal() {
            const modal = document.getElementById('paymentStatusModal');
            if (modal) {
                modal.innerHTML = `
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fa-solid fa-check-circle me-2 text-success"></i>
                                    Đơn hàng đã được xử lý xong
                                </h5>
                            </div>
                            <div class="modal-body text-center">
                                <div class="alert alert-success">
                                    <i class="fa-solid fa-check-circle me-2"></i>
                                    <strong>Đơn hàng của bạn đã được xử lý thành công!</strong>
                                </div>
                                <div class="mb-3">
                                    <i class="fa-solid fa-gift fa-3x text-success mb-3"></i>
                                    <p class="mb-0">Bạn có thể xem chi tiết đơn hàng và nhận sản phẩm ngay bây giờ.</p>
                                </div>
                            </div>
                            <div class="modal-footer justify-content-center">
                                <a href="/orders" class="btn btn-success">
                                    <i class="fa-solid fa-eye me-2"></i>Xem đơn hàng
                                </a>
                                <button type="button" class="btn btn-outline-secondary" onclick="closePaymentModal()">
                                    <i class="fa-solid fa-times me-2"></i>Đóng
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function showPaymentFailedModal(errorMessage) {
            const modal = document.getElementById('paymentStatusModal');
            if (modal) {
                modal.innerHTML = `
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fa-solid fa-exclamation-triangle me-2 text-danger"></i>
                                    Xử lý thất bại
                                </h5>
                            </div>
                            <div class="modal-body text-center">
                                <div class="alert alert-danger">
                                    <i class="fa-solid fa-exclamation-triangle me-2"></i>
                                    <strong>Đơn hàng của bạn xử lý thất bại!</strong>
                                </div>
                                <div class="mb-3">
                                    <i class="fa-solid fa-times-circle fa-3x text-danger mb-3"></i>
                                    <p class="mb-2"><strong>Nguyên nhân:</strong></p>
                                    <p class="text-muted">${errorMessage}</p>
                                </div>
                                <div class="alert alert-info">
                                    <i class="fa-solid fa-info-circle me-2"></i>
                                    Tiền đã được hoàn về ví của bạn. Bạn có thể thử lại sau.
                                </div>
                            </div>
                            <div class="modal-footer justify-content-center">
                                <button type="button" class="btn btn-primary" onclick="closePaymentModal()">
                                    <i class="fa-solid fa-redo me-2"></i>Thử lại
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="closePaymentModal()">
                                    <i class="fa-solid fa-times me-2"></i>Đóng
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function showPaymentTimeoutModal() {
            const modal = document.getElementById('paymentStatusModal');
            if (modal) {
                modal.innerHTML = `
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fa-solid fa-clock me-2 text-warning"></i>
                                    Xử lý quá lâu
                                </h5>
                            </div>
                            <div class="modal-body text-center">
                                <div class="alert alert-warning">
                                    <i class="fa-solid fa-clock me-2"></i>
                                    <strong>Đơn hàng đang xử lý quá lâu!</strong>
                                </div>
                                <div class="mb-3">
                                    <i class="fa-solid fa-hourglass-half fa-3x text-warning mb-3"></i>
                                    <p class="mb-0">Vui lòng kiểm tra trạng thái đơn hàng trong trang đơn hàng.</p>
                                </div>
                            </div>
                            <div class="modal-footer justify-content-center">
                                <a href="/orders" class="btn btn-warning">
                                    <i class="fa-solid fa-eye me-2"></i>Kiểm tra đơn hàng
                                </a>
                                <button type="button" class="btn btn-outline-secondary" onclick="closePaymentModal()">
                                    <i class="fa-solid fa-times me-2"></i>Đóng
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function closePaymentModal() {
            if (paymentStatusInterval) {
                clearInterval(paymentStatusInterval);
                paymentStatusInterval = null;
            }
            
            const modal = document.getElementById('paymentStatusModal');
            if (modal) {
                const bsModal = bootstrap.Modal.getInstance(modal);
                if (bsModal) {
                    bsModal.hide();
                }
                modal.remove();
            }
            
            currentPaymentId = null;
        }

        async function updateQty(productId, quantity) {
            try {
            const q = Math.max(1, parseInt(quantity || '1', 10));
                const res = await fetch(`/api/cart/update/${productId}?quantity=${q}`, { 
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin'
                });
                
                if (res.status === 401) { 
                    window.location.href = '/login'; 
                    return; 
                }
                
                if (!res.ok) {
                    const errorText = await res.text();
                    throw new Error(`API Error: ${res.status} - ${errorText}`);
                }
                
                const response = await res.json();
                if (typeof response === 'string') {
                    throw new Error(`Server Error: ${response}`);
                }
                
            await loadCart();
            } catch (e) {
                console.error('Error updating quantity:', e);
                showNotification('Lỗi cập nhật số lượng: ' + e.message, 'error');
            }
        }

        async function removeItem(productId) {
            try {
                const res = await fetch(`/api/cart/remove/${productId}`, { 
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin'
                });
                
                if (res.status === 401) { 
                    window.location.href = '/login'; 
                    return; 
                }
                
                if (!res.ok) {
                    const errorText = await res.text();
                    throw new Error(`API Error: ${res.status} - ${errorText}`);
                }
                
                const response = await res.json();
                if (typeof response === 'string') {
                    throw new Error(`Server Error: ${response}`);
                }
                
                // Remove from selected items if it was selected
                selectedItems.delete(productId);
            await loadCart();
            } catch (e) {
                console.error('Error removing item:', e);
                showNotification('Lỗi xóa sản phẩm: ' + e.message, 'error');
            }
        }

        async function clearCart() {
            if (!confirm('Bạn có chắc chắn muốn xóa toàn bộ giỏ hàng?')) {
                return;
            }
            
            try {
                const res = await fetch(`/api/cart/clear`, { 
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin'
                });
                
                if (res.status === 401) { 
                    window.location.href = '/login'; 
                    return; 
                }
                
                if (!res.ok) {
                    const errorText = await res.text();
                    throw new Error(`API Error: ${res.status} - ${errorText}`);
                }
                
                const response = await res.json();
                if (typeof response === 'string') {
                    throw new Error(`Server Error: ${response}`);
                }
                
                selectedItems.clear();
            await loadCart();
                showNotification('Đã xóa toàn bộ giỏ hàng', 'success');
            } catch (e) {
                console.error('Error clearing cart:', e);
                showNotification('Lỗi xóa giỏ hàng: ' + e.message, 'error');
            }
        }

        function showNotification(message, type) {
            // Tạo thông báo toast
            const toast = document.createElement('div');
            toast.className = `alert alert-${type === 'success' ? 'success' : 'danger'} position-fixed`;
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            toast.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fa-solid fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
                    <span>${message}</span>
                    <button type="button" class="btn-close ms-auto" onclick="this.parentElement.parentElement.remove()"></button>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Tự động xóa sau 3 giây
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 3000);
        }

        document.addEventListener('DOMContentLoaded', loadCart);
    </script>
</head>
<body>
<nav class="navbar navbar-expand-lg bg-white border-bottom sticky-top">
    <div class="container">
        <a class="navbar-brand d-flex align-items-center me-2" th:href="@{/}" href="/">
            <i class="fa-solid fa-cart-shopping me-2 text-primary"></i>
            License Shop
        </a>
        
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div id="nav" class="collapse navbar-collapse d-flex align-items-center">
            <div class="flex-grow-1 mx-lg-3 d-none d-lg-block">
                <form role="search" th:action="@{/products}" method="get">
                    <div class="input-group">
                        <input type="text" class="form-control" name="q" placeholder="Tìm kiếm tên gian hàng...">
                        <button class="btn btn-primary" type="submit" aria-label="Tìm kiếm"><i class="fa-solid fa-magnifying-glass"></i></button>
                    </div>
                </form>
            </div>
            
            <div class="d-none d-lg-flex align-items-center gap-2 ms-auto">
                <!-- Guest user navigation -->
                <div th:if="${!isAuthenticated}" class="d-flex align-items-center gap-2">
                    <a class="btn btn-outline-secondary d-flex align-items-center gap-2" th:href="@{/login}" href="/login">
                        <i class="fa-regular fa-user"></i>
                        <span>Đăng nhập</span>
                    </a>
                    <a class="btn btn-outline-danger d-flex align-items-center gap-2" th:href="@{/cart}" href="/cart" aria-label="Giỏ hàng">
                        <i class="fa-solid fa-cart-shopping"></i>
                        <span>Giỏ hàng</span>
                    </a>
                </div>
                
                <!-- Authenticated user navigation -->
                <div th:if="${isAuthenticated}" class="d-flex align-items-center gap-2">
                    <!-- Current Balance -->
                    <div class="btn btn-outline-success d-flex align-items-center gap-2" onclick="location.href='/payment'">
                        <i class="fa-solid fa-wallet"></i>
                        <span class="fw-bold" th:text="${#numbers.formatDecimal(walletBalance, 0, 'COMMA', 0, 'POINT')}">0</span>
                    </div>
                    
                    <div class="dropdown">
                        <button class="btn btn-outline-primary dropdown-toggle d-flex align-items-center gap-2" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <img th:src="@{/api/profile/avatar/me}" 
                                 class="rounded-circle" 
                                 style="width: 24px; height: 24px; object-fit: cover;"
                                 onerror="this.src='/images/default-avatar.svg';"
                                 alt="Avatar">
                            <span th:text="${username}">User</span>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" th:href="@{/profile}" href="/profile"><i class="fa-solid fa-user me-2"></i>Thông tin cá nhân</a></li>
                            <li><a class="dropdown-item" th:href="@{/orders}" href="/orders"><i class="fa-solid fa-shopping-bag me-2"></i>Đơn hàng</a></li>
                            <li th:if="${userRole == 'ADMIN'}"><a class="dropdown-item" th:href="@{/admin}" href="/admin"><i class="fa-solid fa-cogs me-2"></i>Quản lý</a></li>
                            <li th:if="${userRole == 'SELLER'}"><a class="dropdown-item" th:href="@{/seller/stall-management}" href="/seller/stall-management"><i class="fa-solid fa-store me-2"></i>Quản lí gian hàng</a></li>
                            <li th:if="${userRole == 'SELLER'}"><a class="dropdown-item" th:href="@{/withdraw}" href="/withdraw"><i class="fa-solid fa-money-bill-transfer me-2"></i>Rút tiền</a></li>
                            <li><a class="dropdown-item" th:href="@{/payment-history}" href="/payment-history"><i class="fa-solid fa-credit-card me-2"></i>Lịch sử thanh toán</a></li>
                            <li><a class="dropdown-item" th:href="@{/change-password}" href="/change-password"><i class="fa-solid fa-key me-2"></i>Đổi mật khẩu</a></li>
                            <li><a class="dropdown-item" href="#"><i class="fa-solid fa-heart me-2"></i>Yêu thích</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="window.authManager.logout(); return false;"><i class="fa-solid fa-right-from-bracket me-2"></i>Đăng xuất</a></li>
                        </ul>
                    </div>

                    <a class="btn btn-outline-secondary d-flex align-items-center gap-2" href="#" aria-label="Tin nhắn">
                        <i class="fa-solid fa-message"></i>
                        <span>Tin nhắn</span>
                    </a>
                    
                    <a class="btn btn-outline-danger d-flex align-items-center gap-2" th:href="@{/cart}" href="/cart" aria-label="Giỏ hàng">
                        <i class="fa-solid fa-cart-shopping"></i>
                        <span>Giỏ hàng</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
</nav>

<main class="container py-4 py-md-5">
    <div class="d-flex align-items-center justify-content-between mb-3">
        <h3 class="page-title m-0"><i class="fa-solid fa-cart-shopping me-2 text-primary"></i>Giỏ hàng</h3>
        <div>
            <a th:href="@{/products}" href="/products" class="btn btn-outline-secondary"><i class="fa-solid fa-arrow-left me-2"></i>Tiếp tục mua sắm</a>
        </div>
    </div>

    <div class="card card-shadow">
        <div class="card-body">
            <div id="empty" class="empty-state d-none">
                <div class="mb-2"><i class="fa-regular fa-face-frown fa-2x"></i></div>
                <div class="mb-3">Giỏ hàng của bạn đang trống</div>
                <a href="/products" class="btn btn-primary btn-sm">Xem sản phẩm</a>
            </div>

            <div id="cart-container">
                <!-- Cart items will be rendered here -->
            </div>
        </div>
    </div>
    
    <!-- Checkout Bar (Fixed at bottom) -->
    <div class="checkout-bar">
        <div class="container">
            <div class="d-flex align-items-center">
                <div class="form-check me-3">
                    <input class="form-check-input" type="checkbox" id="select-all" onchange="toggleAllItems(this.checked)">
                    <label class="form-check-label" for="select-all">
                        Chọn tất cả
                    </label>
                </div>
                <div class="selected-count" id="selected-count">Đã chọn 0 sản phẩm</div>
            </div>
            <div class="d-flex align-items-center">
                <div class="total-price me-3" id="total-price">0 ₫</div>
                <button class="checkout-btn" id="checkout-btn" onclick="checkout()" disabled>
                    Mua hàng
                </button>
            </div>
        </div>
    </div>
</main>

<footer class="border-top py-3 mt-5">
    <div class="container d-flex justify-content-between align-items-center small">
        <div>© <span th:text="${#temporals.format(#temporals.createNow(),'yyyy')}">2025</span> License Shop</div>
        <div class="text-muted">Liên hệ: support@example.com</div>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>



