<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rút tiền - License Shop</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        .withdraw-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .withdraw-card:hover {
            transform: translateY(-5px);
        }
        
        .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 12px;
        }
        
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-approved {
            background-color: #d4edda;
            color: #155724;
        }
        
         .status-rejected {
             background-color: #f8d7da;
             color: #721c24;
         }
         
         .status-cancelled {
             background-color: #e2e3e5;
             color: #6c757d;
         }
        
        .modal-content {
            border-radius: 15px;
            border: none;
        }
        
        .form-control:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }
        
        /* Bảo vệ thanh tìm kiếm khỏi bị ghi đè */
        .navbar .input-group .form-control {
            border-radius: 0.375rem !important;
            padding: 0.375rem 0.75rem !important;
        }
        
        .navbar .input-group .form-control:focus {
            border-color: #86b7fe !important;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25) !important;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #0d6efd 0%, #6610f2 100%);
            border: none;
            border-radius: 10px;
            padding: 12px 30px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        /* Bảo vệ thanh tìm kiếm khỏi bị ghi đè */
        .navbar .input-group .btn-primary {
            background: #0d6efd !important;
            border: 1px solid #0d6efd !important;
            border-radius: 0.375rem !important;
            padding: 0.375rem 0.75rem !important;
            font-weight: 400 !important;
            transform: none !important;
            box-shadow: none !important;
        }
        
        .navbar .input-group .btn-primary:hover {
            background: #0b5ed7 !important;
            border-color: #0a58ca !important;
            transform: none !important;
            box-shadow: none !important;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(13, 110, 253, 0.3);
        }
        
        /* Bảo vệ nút Tạo yêu cầu rút tiền và nút Lọc khỏi bị ghi đè */
        .btn-primary:not(.navbar .input-group .btn-primary) {
            background: linear-gradient(135deg, #0d6efd 0%, #6610f2 100%) !important;
            border: none !important;
            border-radius: 10px !important;
            padding: 12px 30px !important;
            font-weight: 600 !important;
            transition: all 0.3s ease !important;
        }
        
        .btn-primary:not(.navbar .input-group .btn-primary):hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 8px 20px rgba(13, 110, 253, 0.3) !important;
        }
        
        /* Bảo vệ cụ thể cho nút Tạo yêu cầu rút tiền */
        .d-flex.justify-content-between .btn-primary {
            background: linear-gradient(135deg, #0d6efd 0%, #6610f2 100%) !important;
            border: none !important;
            border-radius: 10px !important;
            padding: 12px 30px !important;
            font-weight: 600 !important;
            transition: all 0.3s ease !important;
        }
        
        .d-flex.justify-content-between .btn-primary:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 8px 20px rgba(13, 110, 253, 0.3) !important;
        }
        
        /* Bảo vệ cụ thể cho nút Lọc */
        .d-flex.gap-2 .btn-primary {
            background: linear-gradient(135deg, #0d6efd 0%, #6610f2 100%) !important;
            border: none !important;
            border-radius: 10px !important;
            padding: 12px 30px !important;
            font-weight: 600 !important;
            transition: all 0.3s ease !important;
        }
        
        .d-flex.gap-2 .btn-primary:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 8px 20px rgba(13, 110, 253, 0.3) !important;
        }
        
        .history-item {
            border-left: 4px solid #0d6efd;
            transition: all 0.3s ease;
        }
        
         .history-item:hover {
             background-color: #f8f9fa;
             transform: translateX(5px);
         }
         
         .form-control.is-invalid {
             border-color: #dc3545;
             box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
         }
         
         .invalid-feedback {
             display: block;
             width: 100%;
             margin-top: 0.25rem;
             font-size: 0.875em;
             color: #dc3545;
         }
         
         .btn:disabled {
             opacity: 0.6;
             cursor: not-allowed;
         }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg bg-white border-bottom sticky-top">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center me-2" th:href="@{/}" href="/">
                <i class="fa-solid fa-cart-shopping me-2 text-primary"></i>
                License Shop
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div id="nav" class="collapse navbar-collapse d-flex align-items-center">
                <div class="flex-grow-1 mx-lg-3 d-none d-lg-block">
                    <form role="search" th:action="@{/products}" method="get">
                        <div class="input-group">
                            <input type="text" class="form-control" name="q" placeholder="Tìm kiếm tên gian hàng...">
                            <button class="btn btn-primary" type="submit" aria-label="Tìm kiếm"><i class="fa-solid fa-magnifying-glass"></i></button>
                        </div>
                    </form>
                </div>
                
                <div class="d-none d-lg-flex align-items-center gap-2 ms-auto">
                    <!-- Guest user navigation -->
                    <div th:if="${!isAuthenticated}" class="d-flex align-items-center gap-2">
                        <a class="btn btn-outline-secondary d-flex align-items-center gap-2" th:href="@{/login}" href="/login">
                            <i class="fa-regular fa-user"></i>
                            <span>Đăng nhập</span>
                        </a>
                        <a class="btn btn-outline-danger d-flex align-items-center gap-2" th:href="@{/cart}" href="/cart" aria-label="Giỏ hàng">
                            <i class="fa-solid fa-cart-shopping"></i>
                            <span>Giỏ hàng</span>
                        </a>
                    </div>
                    
                    <!-- Authenticated user navigation -->
                    <div th:if="${isAuthenticated}" class="d-flex align-items-center gap-2">
                        <!-- Current Balance -->
                        <div class="btn btn-outline-success d-flex align-items-center gap-2" onclick="location.href='/payment'">
                            <i class="fa-solid fa-wallet"></i>
                            <span class="fw-bold" th:text="${#numbers.formatDecimal(walletBalance, 0, 'COMMA', 0, 'POINT')}">0</span>
                        </div>

                        <!-- User Profile Dropdown -->
                        <div class="dropdown">
                            <button class="btn btn-outline-primary dropdown-toggle d-flex align-items-center gap-2" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fa-solid fa-user"></i>
                                <span th:text="${username}">User</span>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" th:href="@{/profile}" href="/profile"><i class="fa-solid fa-user me-2"></i>Thông tin cá nhân</a></li>
                                <li><a class="dropdown-item" th:href="@{/orders}" href="/orders"><i class="fa-solid fa-shopping-bag me-2"></i>Đơn hàng</a></li>
                                <li th:if="${userRole == 'SELLER'}"><a class="dropdown-item" th:href="@{/seller/stall-management}" href="/seller/stall-management"><i class="fa-solid fa-store me-2"></i>Quản lí gian hàng</a></li>
                                <li th:if="${userRole == 'SELLER'}"><a class="dropdown-item" th:href="@{/withdraw}" href="/withdraw"><i class="fa-solid fa-money-bill-transfer me-2"></i>Rút tiền</a></li>
                                <li><a class="dropdown-item" th:href="@{/payment-history}" href="/payment-history"><i class="fa-solid fa-credit-card me-2"></i>Lịch sử thanh toán</a></li>
                                <li><a class="dropdown-item" th:href="@{/change-password}" href="/change-password"><i class="fa-solid fa-key me-2"></i>Đổi mật khẩu</a></li>
                                <li><a class="dropdown-item" href="#"><i class="fa-solid fa-heart me-2"></i>Yêu thích</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" onclick="window.authManager.logout(); return false;"><i class="fa-solid fa-right-from-bracket me-2"></i>Đăng xuất</a></li>
                            </ul>
                        </div>

                        <!-- Message Button -->
                        <a class="btn btn-outline-secondary d-flex align-items-center gap-2" href="#" aria-label="Tin nhắn">
                            <i class="fa-solid fa-message"></i>
                            <span>Tin nhắn</span>
                        </a>
                        
                        <!-- Cart Button -->
                        <a class="btn btn-outline-danger d-flex align-items-center gap-2" th:href="@{/cart}" href="/cart" aria-label="Giỏ hàng">
                            <i class="fa-solid fa-cart-shopping"></i>
                            <span>Giỏ hàng</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="container py-4 py-md-5">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h1 class="h3 mb-1">Rút tiền</h1>
                        <p class="text-muted mb-0">Quản lý yêu cầu rút tiền từ ví của bạn</p>
                    </div>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#withdrawModal">
                        <i class="fa-solid fa-plus me-2"></i>Tạo yêu cầu rút tiền
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Filter Form -->
        <div class="row">
            <div class="col-12">
                <div class="card card-shadow mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <i class="fa-solid fa-filter me-2"></i>Bộ lọc
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="filterForm">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label for="startDate" class="form-label">Từ ngày</label>
                                    <input type="date" class="form-control" id="startDate" name="startDate">
                                </div>
                                <div class="col-md-3">
                                    <label for="endDate" class="form-label">Đến ngày</label>
                                    <input type="date" class="form-control" id="endDate" name="endDate">
                                </div>
                                <div class="col-md-3">
                                    <label for="status" class="form-label">Trạng thái</label>
                                    <select class="form-select" id="status" name="status">
                                        <option value="">Tất cả</option>
                                        <option value="PENDING">Đang chờ duyệt</option>
                                        <option value="APPROVED">Đã duyệt</option>
                                        <option value="REJECTED">Đã từ chối</option>
                                        <option value="CANCELLED">Đã hủy</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="minAmount" class="form-label">Số tiền từ (VNĐ)</label>
                                    <input type="number" class="form-control" id="minAmount" name="minAmount" placeholder="0" min="0">
                                </div>
                                <div class="col-md-3">
                                    <label for="maxAmount" class="form-label">Số tiền đến (VNĐ)</label>
                                    <input type="number" class="form-control" id="maxAmount" name="maxAmount" placeholder="Không giới hạn" min="0">
                                </div>
                                <div class="col-md-3">
                                    <label for="filterBankAccountNumber" class="form-label">Số tài khoản</label>
                                    <input type="text" class="form-control" id="filterBankAccountNumber" name="bankAccountNumber" placeholder="Nhập số tài khoản">
                                </div>
                                <div class="col-md-3">
                                    <label for="filterBankName" class="form-label">Tên ngân hàng</label>
                                    <input type="text" class="form-control" id="filterBankName" name="bankName" placeholder="Nhập tên ngân hàng">
                                </div>
                                <div class="col-md-3">
                                    <label for="filterBankAccountName" class="form-label">Tên người nhận</label>
                                    <input type="text" class="form-control" id="filterBankAccountName" name="bankAccountName" placeholder="Nhập tên người nhận">
                                </div>
                                <div class="col-12">
                                    <div class="d-flex gap-2">
                                        <button type="button" class="btn btn-primary" onclick="applyFilters()">
                                            <i class="fa-solid fa-search me-2"></i>Lọc
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="clearFilters()">
                                            <i class="fa-solid fa-times me-2"></i>Xóa bộ lọc
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Wallet Balance Card -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card withdraw-card">
                    <div class="card-body text-center">
                        <div class="mb-3">
                            <i class="fa-solid fa-wallet fa-3x text-primary"></i>
                        </div>
                        <h4 class="card-title">Số dư hiện tại</h4>
                        <h2 class="text-primary fw-bold" th:text="${#numbers.formatDecimal(walletBalance, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'">0 VNĐ</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- Withdraw History -->
        <div class="row">
            <div class="col-12">
                <div class="card withdraw-card">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="fa-solid fa-history me-2"></i>Lịch sử yêu cầu rút tiền</h5>
                    </div>
                    <div class="card-body">
                        <div id="withdrawHistory">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Đang tải...</span>
                                </div>
                                <p class="mt-2 text-muted">Đang tải dữ liệu...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Withdraw Modal -->
    <div class="modal fade" id="withdrawModal" tabindex="-1" aria-labelledby="withdrawModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="withdrawModalLabel">
                        <i class="fa-solid fa-money-bill-transfer me-2"></i>Tạo yêu cầu rút tiền
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="withdrawForm">
                    <div class="modal-body">
                        <!-- Step 1: Withdraw Form -->
                        <div id="withdrawFormStep" class="withdraw-step">
                            <div class="row g-3">
                                 <div class="col-12">
                                    <label for="amount" class="form-label">Số tiền cần rút (VNĐ) <span class="text-danger">*</span></label>
                                     <input type="number" class="form-control" id="amount" name="amount" 
                                            placeholder="Nhập số tiền cần rút (tối thiểu 100,000 VNĐ)" 
                                            min="100000" step="1000" required>
                                    <div class="form-text">Số dư hiện tại: <span id="currentBalance" th:text="${#numbers.formatDecimal(walletBalance, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'">0 VNĐ</span></div>
                                </div>
                                <div class="col-md-6">
                                    <label for="bankAccountNumber" class="form-label">Số tài khoản <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="bankAccountNumber" name="bankAccountNumber" 
                                           placeholder="Nhập số tài khoản" maxlength="50" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="bankAccountName" class="form-label">Tên chủ tài khoản <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="bankAccountName" name="bankAccountName" 
                                           placeholder="Nhập tên chủ tài khoản" maxlength="100" required>
                                </div>
                                <div class="col-12">
                                    <label for="bankName" class="form-label">Tên ngân hàng <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="bankName" name="bankName" 
                                           placeholder="Nhập tên ngân hàng" maxlength="100" required>
                                </div>
                                <div class="col-12">
                                    <label for="note" class="form-label">Ghi chú (tùy chọn)</label>
                                    <textarea class="form-control" id="note" name="note" rows="3" 
                                              placeholder="Nhập ghi chú (nếu có)" maxlength="255"></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Step 2: OTP Verification -->
                        <div id="otpVerificationStep" class="withdraw-step" style="display: none;">
                            <div class="text-center mb-4">
                                <i class="fa-solid fa-envelope fa-3x text-primary mb-3"></i>
                                <h5>Xác thực OTP</h5>
                                <p class="text-muted">Mã OTP đã được gửi đến email của bạn. Vui lòng nhập mã để xác thực.</p>
                            </div>
                            <div class="row g-3">
                                <div class="col-12">
                                    <label for="otp" class="form-label">Mã OTP <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control text-center" id="otp" name="otp" 
                                           placeholder="Nhập mã OTP 6 số" maxlength="6" required>
                                    <div class="form-text">
                                        <span id="otpTimer" class="text-warning"></span>
                                        <button type="button" id="resendOtpBtn" class="btn btn-link btn-sm" style="display: none;">
                                            Gửi lại OTP
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                        <button type="button" id="sendOtpBtn" class="btn btn-primary">
                            <i class="fa-solid fa-paper-plane me-2"></i>Gửi OTP
                        </button>
                        <button type="submit" id="submitWithdrawBtn" class="btn btn-primary" style="display: none;">
                            <i class="fa-solid fa-check me-2"></i>Xác thực và gửi yêu cầu
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <footer class="border-top py-3 mt-5">
        <div class="container d-flex justify-content-between align-items-center small">
            <div>© <span th:text="${#dates.format(#dates.createNow(),'yyyy')}">2025</span> License Shop</div>
            <div class="text-muted">Liên hệ: support@example.com</div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/auth.js"></script>
    <script>
        let currentBalance = 0; // Will be initialized when modal opens
        let otpTimer = null;
        let otpCountdown = 0;
        
        document.addEventListener('DOMContentLoaded', function() {
            loadWithdrawHistory();
            
            // Initialize currentBalance when the page loads
            const balanceElement = document.getElementById('currentBalance');
            if (balanceElement) {
                currentBalance = parseFloat(balanceElement.textContent.replace(/[^\d]/g, ''));
                console.log('Initial currentBalance:', currentBalance);
            }
            
            // Re-initialize balance when modal opens
            const withdrawModal = document.getElementById('withdrawModal');
            if (withdrawModal) {
                withdrawModal.addEventListener('shown.bs.modal', function() {
                    const balanceElement = document.getElementById('currentBalance');
                    if (balanceElement) {
                        currentBalance = parseFloat(balanceElement.textContent.replace(/[^\d]/g, ''));
                        console.log('Modal opened, currentBalance:', currentBalance);
                    }
                    
                    // Reset form and update button state
                    resetWithdrawForm();
                });
            }
            
            // Form submission
            document.getElementById('withdrawForm').addEventListener('submit', function(e) {
                e.preventDefault();
                submitWithdrawRequest();
            });
            
             // Amount validation with real-time feedback
             document.getElementById('amount').addEventListener('input', function() {
                 const amountValue = this.value;
                 const amount = parseFloat(amountValue);
                 const errorElement = this.parentElement.querySelector('.invalid-feedback');
                 
                 console.log('Amount input:', amountValue, 'Parsed:', amount);
                 
                 if (amountValue === '' || isNaN(amount) || amount <= 0) {
                     this.setCustomValidity('Số tiền phải lớn hơn 0');
                     showFieldError(this, 'Số tiền phải lớn hơn 0');
                 } else if (amount < 100000) {
                     this.setCustomValidity('Số tiền tối thiểu để rút là 100,000 VNĐ');
                     showFieldError(this, 'Số tiền tối thiểu để rút là 100,000 VNĐ');
                 } else if (amount > currentBalance) {
                     this.setCustomValidity('Số tiền không được vượt quá số dư hiện tại');
                     showFieldError(this, 'Số tiền không được vượt quá số dư hiện tại');
                 } else {
                     this.setCustomValidity('');
                     clearFieldError(this);
                 }
                 
                 // Update send OTP button state
                 updateSendOtpButtonState();
             });
            
             // Send OTP button
             document.getElementById('sendOtpBtn').addEventListener('click', function() {
                 // Validate form before sending OTP
                 if (!validateWithdrawForm()) {
                     return;
                 }
                 
                 // Disable button immediately to prevent spam
                 this.disabled = true;
                 this.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-2"></i>Đang gửi...';
                 
                 sendOtp();
             });
            
             // Resend OTP button
             document.getElementById('resendOtpBtn').addEventListener('click', function() {
                 // Disable button immediately to prevent spam
                 this.disabled = true;
                 this.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-2"></i>Đang gửi...';
                 
                 sendOtp();
             });
            
             // Bank account number validation
             document.getElementById('bankAccountNumber').addEventListener('input', function() {
                 this.value = this.value.replace(/[^0-9]/g, '');
                 
                 if (this.value.length > 0 && this.value.length < 8) {
                     this.setCustomValidity('Số tài khoản phải có ít nhất 8 ký tự');
                     showFieldError(this, 'Số tài khoản phải có ít nhất 8 ký tự');
                 } else if (this.value.length >= 8) {
                     this.setCustomValidity('');
                     clearFieldError(this);
                 } else {
                     this.setCustomValidity('');
                     clearFieldError(this);
                 }
                 
                 updateSendOtpButtonState();
             });
             
             // Bank account name validation
             document.getElementById('bankAccountName').addEventListener('input', function() {
                 if (this.value.length > 0 && this.value.length < 2) {
                     this.setCustomValidity('Tên chủ tài khoản phải có ít nhất 2 ký tự');
                     showFieldError(this, 'Tên chủ tài khoản phải có ít nhất 2 ký tự');
                 } else if (this.value.length >= 2) {
                     this.setCustomValidity('');
                     clearFieldError(this);
                 } else {
                     this.setCustomValidity('');
                     clearFieldError(this);
                 }
                 
                 updateSendOtpButtonState();
             });
             
             // Bank name validation
             document.getElementById('bankName').addEventListener('input', function() {
                 if (this.value.length > 0 && this.value.length < 2) {
                     this.setCustomValidity('Tên ngân hàng phải có ít nhất 2 ký tự');
                     showFieldError(this, 'Tên ngân hàng phải có ít nhất 2 ký tự');
                 } else if (this.value.length >= 2) {
                     this.setCustomValidity('');
                     clearFieldError(this);
                 } else {
                     this.setCustomValidity('');
                     clearFieldError(this);
                 }
                 
                 updateSendOtpButtonState();
             });
             
             // OTP input validation
             document.getElementById('otp').addEventListener('input', function() {
                 this.value = this.value.replace(/[^0-9]/g, '');
             });
        });
        
        async function loadWithdrawHistory(filterParams = {}) {
            try {
                // Build query string from filter parameters
                const queryParams = new URLSearchParams();
                
                if (filterParams.startDate) queryParams.append('startDate', filterParams.startDate);
                if (filterParams.endDate) queryParams.append('endDate', filterParams.endDate);
                if (filterParams.status) queryParams.append('status', filterParams.status);
                if (filterParams.minAmount) queryParams.append('minAmount', filterParams.minAmount);
                if (filterParams.maxAmount) queryParams.append('maxAmount', filterParams.maxAmount);
                if (filterParams.bankAccountNumber) queryParams.append('bankAccountNumber', filterParams.bankAccountNumber);
                if (filterParams.bankName) queryParams.append('bankName', filterParams.bankName);
                if (filterParams.bankAccountName) queryParams.append('bankAccountName', filterParams.bankAccountName);
                
                const url = `/api/withdraw/requests${queryParams.toString() ? '?' + queryParams.toString() : ''}`;
                const response = await fetch(url);
                const requests = await response.json();
                
                const historyContainer = document.getElementById('withdrawHistory');
                
                if (requests.length === 0) {
                    historyContainer.innerHTML = `
                        <div class="text-center py-5">
                            <i class="fa-solid fa-inbox fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">Chưa có yêu cầu rút tiền nào</h5>
                            <p class="text-muted">Bạn chưa tạo yêu cầu rút tiền nào.</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                requests.forEach(request => {
                    const statusClass = getStatusClass(request.status);
                    const statusText = getStatusText(request.status);
                    const createdAt = new Date(request.createdAt).toLocaleString('vi-VN');
                    
                    html += `
                        <div class="history-item p-3 mb-3 border rounded">
                            <div class="row align-items-center">
                                <div class="col-md-3">
                                    <div class="fw-bold text-primary">${formatNumber(request.amount)} VNĐ</div>
                                    <small class="text-muted">${createdAt}</small>
                                </div>
                                <div class="col-md-3">
                                    <div class="fw-bold">${request.bankName}</div>
                                    <small class="text-muted">${request.bankAccountNumber}</small>
                                </div>
                                <div class="col-md-3">
                                    <div class="fw-bold">${request.bankAccountName}</div>
                                    ${request.note ? `<small class="text-muted">${request.note}</small>` : ''}
                                </div>
                                <div class="col-md-3 text-end">
                                    <span class="status-badge ${statusClass}">${statusText}</span>
                                    ${request.status === 'PENDING' ? `
                                        <div class="mt-2">
                                            <button class="btn btn-outline-danger btn-sm" onclick="cancelWithdrawRequest(${request.id})">
                                                <i class="fa-solid fa-times me-1"></i>Hủy yêu cầu
                                            </button>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                historyContainer.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading withdraw history:', error);
                document.getElementById('withdrawHistory').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fa-solid fa-exclamation-triangle me-2"></i>
                        Có lỗi xảy ra khi tải dữ liệu. Vui lòng thử lại.
                    </div>
                `;
            }
        }
        
         async function sendOtp() {
             try {
                 const response = await fetch('/api/withdraw/send-otp', {
                     method: 'POST',
                     headers: {
                         'Content-Type': 'application/json',
                     },
                     body: JSON.stringify({})
                 });
                 
                 const result = await response.json();
                 
                 if (response.ok) {
                     // Show OTP step immediately
                     showOtpStep();
                     startOtpTimer();
                     showAlert('success', result.message);
                 } else {
                     showAlert('danger', result.error || 'Không thể gửi OTP');
                     // Re-enable buttons on error
                     resetOtpButtons();
                     updateSendOtpButtonState();
                 }
                 
             } catch (error) {
                 console.error('Error sending OTP:', error);
                 showAlert('danger', 'Có lỗi xảy ra khi gửi OTP');
                 // Re-enable buttons on error
                 resetOtpButtons();
                 updateSendOtpButtonState();
             }
         }
        
        function showOtpStep() {
            document.getElementById('withdrawFormStep').style.display = 'none';
            document.getElementById('otpVerificationStep').style.display = 'block';
            document.getElementById('sendOtpBtn').style.display = 'none';
            document.getElementById('submitWithdrawBtn').style.display = 'inline-block';
        }
        
         function startOtpTimer() {
             otpCountdown = 60; // 60 seconds
             const timerElement = document.getElementById('otpTimer');
             const resendBtn = document.getElementById('resendOtpBtn');
             
             // Reset resend button state
             resendBtn.disabled = false;
             resendBtn.innerHTML = 'Gửi lại OTP';
             
             otpTimer = setInterval(() => {
                 otpCountdown--;
                 timerElement.textContent = `Mã OTP hết hạn sau ${otpCountdown} giây`;
                 
                 if (otpCountdown <= 0) {
                     clearInterval(otpTimer);
                     timerElement.textContent = 'Mã OTP đã hết hạn';
                     resendBtn.style.display = 'inline-block';
                 }
             }, 1000);
         }
        
        async function submitWithdrawRequest() {
            const form = document.getElementById('withdrawForm');
            const formData = new FormData(form);
            
            const requestData = {
                amount: parseFloat(formData.get('amount')),
                bankAccountNumber: formData.get('bankAccountNumber'),
                bankAccountName: formData.get('bankAccountName'),
                bankName: formData.get('bankName'),
                note: formData.get('note') || null,
                otp: formData.get('otp')
            };
            
            try {
                const response = await fetch('/api/withdraw/request', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // Success
                    const modal = bootstrap.Modal.getInstance(document.getElementById('withdrawModal'));
                    modal.hide();
                    
                    // Show success message
                    showAlert('success', 'Tạo yêu cầu rút tiền thành công! Yêu cầu của bạn đang được xem xét. Trang sẽ được tải lại để cập nhật số dư.');
                    
                    // Reset form
                    resetWithdrawForm();
                    
                    // Reload page after 2 seconds to show updated balance
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                    
                } else {
                    // Error
                    showAlert('danger', result.error || 'Có lỗi xảy ra khi tạo yêu cầu rút tiền');
                }
                
            } catch (error) {
                console.error('Error submitting withdraw request:', error);
                showAlert('danger', 'Có lỗi xảy ra khi tạo yêu cầu rút tiền');
            }
        }
        
         function resetWithdrawForm() {
             document.getElementById('withdrawForm').reset();
             document.getElementById('withdrawFormStep').style.display = 'block';
             document.getElementById('otpVerificationStep').style.display = 'none';
             document.getElementById('sendOtpBtn').style.display = 'inline-block';
             document.getElementById('submitWithdrawBtn').style.display = 'none';
             
             if (otpTimer) {
                 clearInterval(otpTimer);
             }
             document.getElementById('otpTimer').textContent = '';
             document.getElementById('resendOtpBtn').style.display = 'none';
             
             // Clear all validation errors
             const fields = ['amount', 'bankAccountNumber', 'bankAccountName', 'bankName'];
             fields.forEach(fieldId => {
                 const field = document.getElementById(fieldId);
                 clearFieldError(field);
             });
             
             // Reset button states
             resetOtpButtons();
             
             // Update button state
             updateSendOtpButtonState();
         }
         
         function resetOtpButtons() {
             const sendOtpBtn = document.getElementById('sendOtpBtn');
             const resendOtpBtn = document.getElementById('resendOtpBtn');
             
             // Reset send OTP button
             sendOtpBtn.disabled = false;
             sendOtpBtn.innerHTML = '<i class="fa-solid fa-paper-plane me-2"></i>Gửi OTP';
             
             // Reset resend OTP button
             resendOtpBtn.disabled = false;
             resendOtpBtn.innerHTML = 'Gửi lại OTP';
         }
         
         function showFieldError(field, message) {
             // Remove existing error feedback
             const existingError = field.parentElement.querySelector('.invalid-feedback');
             if (existingError) {
                 existingError.remove();
             }
             
             // Add error class
             field.classList.add('is-invalid');
             
             // Add error message
             const errorDiv = document.createElement('div');
             errorDiv.className = 'invalid-feedback';
             errorDiv.textContent = message;
             field.parentElement.appendChild(errorDiv);
         }
         
         function clearFieldError(field) {
             field.classList.remove('is-invalid');
             const errorDiv = field.parentElement.querySelector('.invalid-feedback');
             if (errorDiv) {
                 errorDiv.remove();
             }
         }
         
         function updateSendOtpButtonState() {
             const sendOtpBtn = document.getElementById('sendOtpBtn');
             const isFormValid = isWithdrawFormValid();
             
             sendOtpBtn.disabled = !isFormValid;
             
             if (isFormValid) {
                 sendOtpBtn.classList.remove('btn-secondary');
                 sendOtpBtn.classList.add('btn-primary');
             } else {
                 sendOtpBtn.classList.remove('btn-primary');
                 sendOtpBtn.classList.add('btn-secondary');
             }
         }
         
         function isWithdrawFormValid() {
             const amountInput = document.getElementById('amount').value;
             const amount = parseFloat(amountInput.replace(/,/g, '')); // Remove commas if any
             const bankAccountNumber = document.getElementById('bankAccountNumber').value.trim();
             const bankAccountName = document.getElementById('bankAccountName').value.trim();
             const bankName = document.getElementById('bankName').value.trim();
             
             console.log('Validating form:', {
                 amountInput: amountInput,
                 amount: amount,
                 bankAccountNumber: bankAccountNumber,
                 bankAccountName: bankAccountName,
                 bankName: bankName,
                 currentBalance: currentBalance
             });
             
             // Check amount
             if (!amountInput || isNaN(amount) || amount <= 0) {
                 console.log('Amount validation failed: empty, NaN or <= 0');
                 return false;
             }
             
             if (amount < 100000) {
                 console.log('Amount validation failed: less than 100000, amount =', amount);
                 return false;
             }
             
             if (amount > currentBalance) {
                 console.log('Amount validation failed: exceeds balance', amount, '>', currentBalance);
                 return false;
             }
             
             // Check bank account number
             if (!bankAccountNumber || bankAccountNumber.length < 8) {
                 console.log('Bank account number validation failed:', bankAccountNumber);
                 return false;
             }
             
             // Check bank account name
             if (!bankAccountName || bankAccountName.length < 2) {
                 console.log('Bank account name validation failed:', bankAccountName);
                 return false;
             }
             
             // Check bank name
             if (!bankName || bankName.length < 2) {
                 console.log('Bank name validation failed:', bankName);
                 return false;
             }
             
             console.log('Form is valid!');
             return true;
         }
         
         function validateWithdrawForm() {
             const amountInput = document.getElementById('amount').value;
             const amount = parseFloat(amountInput.replace(/,/g, ''));
             const bankAccountNumber = document.getElementById('bankAccountNumber').value.trim();
             const bankAccountName = document.getElementById('bankAccountName').value.trim();
             const bankName = document.getElementById('bankName').value.trim();
             
             console.log('Validate form - Amount:', amount, 'Bank Account Number:', bankAccountNumber, 'Bank Account Name:', bankAccountName, 'Bank Name:', bankName);
             
             let isValid = true;
             
             // Validate amount
             if (isNaN(amount) || amount <= 0) {
                 showAlert('danger', 'Số tiền phải lớn hơn 0');
                 document.getElementById('amount').focus();
                 isValid = false;
             } else if (amount < 100000) {
                 showAlert('danger', 'Số tiền tối thiểu để rút là 100,000 VNĐ');
                 document.getElementById('amount').focus();
                 isValid = false;
             } else if (amount > currentBalance) {
                 showAlert('danger', 'Số tiền không được vượt quá số dư hiện tại');
                 document.getElementById('amount').focus();
                 isValid = false;
             }
             
             // Validate bank account number
             if (!bankAccountNumber) {
                 showAlert('danger', 'Vui lòng nhập số tài khoản');
                 document.getElementById('bankAccountNumber').focus();
                 isValid = false;
             } else if (bankAccountNumber.length < 8) {
                 showAlert('danger', 'Số tài khoản phải có ít nhất 8 ký tự');
                 document.getElementById('bankAccountNumber').focus();
                 isValid = false;
             }
             
             // Validate bank account name
             if (!bankAccountName) {
                 showAlert('danger', 'Vui lòng nhập tên chủ tài khoản');
                 document.getElementById('bankAccountName').focus();
                 isValid = false;
             } else if (bankAccountName.length < 2) {
                 showAlert('danger', 'Tên chủ tài khoản phải có ít nhất 2 ký tự');
                 document.getElementById('bankAccountName').focus();
                 isValid = false;
             }
             
             // Validate bank name
             if (!bankName) {
                 showAlert('danger', 'Vui lòng nhập tên ngân hàng');
                 document.getElementById('bankName').focus();
                 isValid = false;
             } else if (bankName.length < 2) {
                 showAlert('danger', 'Tên ngân hàng phải có ít nhất 2 ký tự');
                 document.getElementById('bankName').focus();
                 isValid = false;
             }
             
             return isValid;
         }
        
        async function cancelWithdrawRequest(requestId) {
            if (!confirm('Bạn có chắc chắn muốn hủy yêu cầu rút tiền này? Số tiền sẽ được trả về ví của bạn.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/withdraw/cancel/${requestId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('success', result.message);
                    loadWithdrawHistory(); // Reload history
                    // Reload page to update balance
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    showAlert('danger', result.error || 'Có lỗi xảy ra khi hủy yêu cầu');
                }
                
            } catch (error) {
                console.error('Error canceling withdraw request:', error);
                showAlert('danger', 'Có lỗi xảy ra khi hủy yêu cầu');
            }
        }
        
         function getStatusClass(status) {
             switch (status) {
                 case 'PENDING': return 'status-pending';
                 case 'APPROVED': return 'status-approved';
                 case 'REJECTED': return 'status-rejected';
                 case 'CANCELLED': return 'status-cancelled';
                 default: return 'status-pending';
             }
         }
        
         function getStatusText(status) {
             switch (status) {
                 case 'PENDING': return 'Đang chờ duyệt';
                 case 'APPROVED': return 'Đã duyệt';
                 case 'REJECTED': return 'Đã từ chối';
                 case 'CANCELLED': return 'Đã hủy';
                 default: return 'Đang chờ duyệt';
             }
         }
        
        function formatNumber(num) {
            return new Intl.NumberFormat('vi-VN').format(num);
        }
        
        function applyFilters() {
            const filterParams = {
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                status: document.getElementById('status').value,
                minAmount: document.getElementById('minAmount').value,
                maxAmount: document.getElementById('maxAmount').value,
                bankAccountNumber: document.getElementById('filterBankAccountNumber').value,
                bankName: document.getElementById('filterBankName').value,
                bankAccountName: document.getElementById('filterBankAccountName').value
            };
            
            // Remove empty values
            Object.keys(filterParams).forEach(key => {
                if (!filterParams[key]) {
                    delete filterParams[key];
                }
            });
            
            loadWithdrawHistory(filterParams);
        }
        
        function clearFilters() {
            document.getElementById('filterForm').reset();
            loadWithdrawHistory();
        }
        
        function showAlert(type, message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }
    </script>
</body>
</html>
